<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Đơn Hàng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #f8f9fa;
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal:not(.is-open) {
            opacity: 0;
            visibility: hidden;
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        .status-pending_confirmation { background-color: #e0e7ff; color: #4338ca; }
        .status-processing { background-color: #cffafe; color: #0891b2; }
        .status-shipped { background-color: #d1fae5; color: #059669; }
        .status-delivered { background-color: #dcfce7; color: #16a34a; }
        .status-cancelled { background-color: #fee2e2; color: #dc2626; }
        .payment-pending { background-color: #fef3c7; color: #d97706; }
        .payment-paid { background-color: #dcfce7; color: #16a34a; }
        .payment-failed { background-color: #fee2e2; color: #dc2626; }
        
        /* Custom scrollbar for modal */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-screen-2xl mx-auto">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Quản Lý Đơn Hàng</h1>
            <p class="text-gray-500 mt-1">Xem, tìm kiếm và quản lý tất cả đơn hàng của bạn.</p>
        </header>

        <!-- Filter Section -->
        <div class="bg-white p-6 rounded-xl shadow-sm mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div>
                    <label for="search" class="block text-sm font-medium text-gray-700 mb-1">Tìm kiếm</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                            <i class="fas fa-search text-gray-400"></i>
                        </span>
                        <input type="text" id="search" placeholder="Mã ĐH, Tên, Email, SĐT..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                <div>
                    <label for="order-status" class="block text-sm font-medium text-gray-700 mb-1">Trạng thái đơn hàng</label>
                    <select id="order-status" class="w-full py-2 px-3 border border-gray-300 bg-white rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Tất cả</option>
                        <option value="pending_confirmation">Chờ xác nhận</option>
                        <option value="processing">Đang xử lý</option>
                        <option value="shipped">Đã giao hàng</option>
                        <option value="delivered">Giao thành công</option>
                        <option value="cancelled">Đã hủy</option>
                    </select>
                </div>
                 <div>
                    <label for="payment-status" class="block text-sm font-medium text-gray-700 mb-1">Trạng thái thanh toán</label>
                    <select id="payment-status" class="w-full py-2 px-3 border border-gray-300 bg-white rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Tất cả</option>
                        <option value="pending">Chờ thanh toán</option>
                        <option value="paid">Đã thanh toán</option>
                        <option value="failed">Thất bại</option>
                    </select>
                </div>
                <div>
                    <label for="date-range" class="block text-sm font-medium text-gray-700 mb-1">Khoảng ngày</label>
                    <input type="date" id="date-range" class="w-full py-2 px-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
             <div class="mt-4 flex justify-end space-x-3">
                <button id="clear-filters" class="px-5 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold">Xóa lọc</button>
                <button id="apply-filters" class="px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold flex items-center space-x-2">
                    <i class="fas fa-filter"></i>
                    <span>Áp dụng</span>
                </button>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="bg-white rounded-xl shadow-sm overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-600">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        <th scope="col" class="p-6">Mã ĐH</th>
                        <th scope="col" class="p-6">Khách hàng</th>
                        <th scope="col" class="p-6">Tổng tiền</th>
                        <th scope="col" class="p-6">Trạng thái ĐH</th>
                        <th scope="col" class="p-6">TT Thanh toán</th>
                        <th scope="col" class="p-6">Ngày tạo</th>
                        <th scope="col" class="p-6 text-center">Hành động</th>
                    </tr>
                </thead>
                <tbody id="orders-tbody">
                    <!-- Order rows will be inserted here by JavaScript -->
                </tbody>
            </table>
            <div id="pagination" class="p-6 flex justify-between items-center">
                 <!-- Pagination controls will be inserted here -->
            </div>
        </div>
    </div>
    
    <!-- Order Detail Modal -->
    <div id="order-detail-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl h-full max-h-[90vh] flex flex-col transform transition-transform duration-300 scale-95">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800">Chi tiết đơn hàng: <span id="modal-order-code" class="text-indigo-600"></span></h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times fa-2x"></i>
                </button>
            </div>
            <div class="p-8 flex-grow overflow-y-auto modal-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Left Column: Customer & Address -->
                    <div class="lg:col-span-1 space-y-6">
                        <div>
                            <h3 class="font-bold text-lg text-gray-800 mb-3 border-b pb-2">Thông tin khách hàng</h3>
                            <p><strong>Tên:</strong> <span id="modal-customer-name"></span></p>
                            <p><strong>Email:</strong> <span id="modal-customer-email"></span></p>
                            <p><strong>SĐT:</strong> <span id="modal-customer-phone"></span></p>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-gray-800 mb-3 border-b pb-2">Địa chỉ giao hàng</h3>
                            <address class="not-italic" id="modal-shipping-address"></address>
                        </div>
                         <div>
                            <h3 class="font-bold text-lg text-gray-800 mb-3 border-b pb-2">Ghi chú</h3>
                            <p class="text-gray-600 italic" id="modal-customer-notes">Không có ghi chú.</p>
                        </div>
                    </div>
                    <!-- Right Column: Order Info & Items -->
                    <div class="lg:col-span-2">
                        <div class="bg-gray-50 p-4 rounded-lg mb-6">
                            <h3 class="font-bold text-lg text-gray-800 mb-4">Tổng quan đơn hàng</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                <div>
                                    <p class="text-sm text-gray-500">Ngày đặt</p>
                                    <p class="font-semibold text-gray-800" id="modal-order-date"></p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Trạng thái</p>
                                    <span id="modal-order-status" class="status-badge"></span>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Thanh toán</p>
                                    <span id="modal-payment-status" class="status-badge"></span>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Phương thức TT</p>
                                    <p class="font-semibold text-gray-800" id="modal-payment-method"></p>
                                </div>
                            </div>
                        </div>

                        <h3 class="font-bold text-lg text-gray-800 mb-3">Sản phẩm trong đơn</h3>
                        <div class="border rounded-lg overflow-hidden">
                           <table class="w-full">
                               <thead class="bg-gray-50 text-left text-sm text-gray-600">
                                   <tr>
                                       <th class="p-3">Sản phẩm</th>
                                       <th class="p-3 text-center">Số lượng</th>
                                       <th class="p-3 text-right">Đơn giá</th>
                                       <th class="p-3 text-right">Thành tiền</th>
                                   </tr>
                               </thead>
                               <tbody id="modal-order-items"></tbody>
                           </table>
                        </div>

                        <div class="mt-6 flex justify-end">
                            <div class="w-full md:w-1/2">
                                <dl class="space-y-2 text-gray-700">
                                    <div class="flex justify-between">
                                        <dt>Tổng tiền hàng:</dt>
                                        <dd class="font-medium" id="modal-sub-total"></dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt>Phí vận chuyển:</dt>
                                        <dd class="font-medium" id="modal-shipping-fee"></dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt>Giảm giá:</dt>
                                        <dd class="font-medium text-red-500" id="modal-discount"></dd>
                                    </div>
                                    <div class="flex justify-between text-xl font-bold text-gray-900 border-t pt-2 mt-2">
                                        <dt>Tổng cộng:</dt>
                                        <dd id="modal-grand-total"></dd>
                                    </div>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
             <div class="p-4 bg-gray-50 border-t flex justify-end space-x-3">
                <button onclick="closeModal()" class="px-5 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold">Đóng</button>
                <button class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold flex items-center space-x-2">
                     <i class="fas fa-print"></i>
                    <span>In hóa đơn</span>
                </button>
            </div>
        </div>
    </div>

    <script>
    // --- MOCK DATA ---
    const mockOrders = [
        {
            id: 1,
            user_id: 101,
            order_code: "DH-20230001",
            customer_name: "Nguyễn Văn An",
            customer_email: "an.nguyen@example.com",
            customer_phone: "0987654321",
            shipping_address_line1: "123 Đường Lê Lợi",
            shipping_city: "TP. Hồ Chí Minh",
            shipping_district: "Quận 1",
            shipping_ward: "Phường Bến Nghé",
            sub_total: 25000000,
            shipping_fee: 50000,
            discount_amount: 0,
            grand_total: 25050000,
            payment_method: "COD",
            payment_status: "pending",
            status: "pending_confirmation",
            notes_from_customer: "Giao hàng trong giờ hành chính.",
            created_at: "2023-10-27T10:00:00Z",
            items: [
                { name: "iPhone 15 Pro Max 256GB - Titan Tự nhiên", quantity: 1, price: 25000000 }
            ]
        },
        {
            id: 2,
            user_id: 102,
            order_code: "DH-20230002",
            customer_name: "Trần Thị Bình",
            customer_email: "binh.tran@example.com",
            customer_phone: "0912345678",
            shipping_address_line1: "456 Đường Nguyễn Huệ",
            shipping_city: "Hà Nội",
            shipping_district: "Quận Hoàn Kiếm",
            shipping_ward: "Phường Hàng Trống",
            sub_total: 3500000,
            shipping_fee: 30000,
            discount_amount: 100000,
            grand_total: 3430000,
            payment_method: "Bank Transfer",
            payment_status: "paid",
            status: "processing",
            notes_from_customer: null,
            created_at: "2023-10-27T11:30:00Z",
            items: [
                { name: "Tai nghe Sony WH-1000XM5", quantity: 1, price: 2000000 },
                { name: "Chuột Logitech MX Master 3S", quantity: 1, price: 1500000 },
            ]
        },
        {
            id: 3,
            user_id: null,
            order_code: "DH-20230003",
            customer_name: "Lê Văn Cường (Khách vãng lai)",
            customer_email: "cuong.le@guest.com",
            customer_phone: "0905123456",
            shipping_address_line1: "789 Đường 3/2",
            shipping_city: "Đà Nẵng",
            shipping_district: "Quận Hải Châu",
            shipping_ward: "Phường Thạch Thang",
            sub_total: 550000,
            shipping_fee: 25000,
            discount_amount: 0,
            grand_total: 575000,
            payment_method: "COD",
            payment_status: "pending",
            status: "shipped",
            notes_from_customer: "Vui lòng gọi trước khi giao.",
            created_at: "2023-10-26T15:00:00Z",
            items: [
                { name: "Sạc dự phòng Anker PowerCore 10000", quantity: 1, price: 550000 }
            ]
        },
        {
            id: 4,
            user_id: 103,
            order_code: "DH-20230004",
            customer_name: "Phạm Thị Dung",
            customer_email: "dung.pham@example.com",
            customer_phone: "0934567890",
            shipping_address_line1: "246 Đường Võ Văn Tần",
            shipping_city: "TP. Hồ Chí Minh",
            shipping_district: "Quận 3",
            shipping_ward: "Phường 6",
            sub_total: 18990000,
            shipping_fee: 0,
            discount_amount: 500000,
            grand_total: 18490000,
            payment_method: "Online Payment",
            payment_status: "paid",
            status: "delivered",
            notes_from_customer: "",
            created_at: "2023-10-25T09:12:00Z",
            items: [
                { name: "Macbook Air M1 8GB/256GB", quantity: 1, price: 18990000 }
            ]
        },
         {
            id: 5,
            user_id: 104,
            order_code: "DH-20230005",
            customer_name: "Hoàng Văn Em",
            customer_email: "em.hoang@example.com",
            customer_phone: "0978111222",
            shipping_address_line1: "111 Đường Cách Mạng Tháng Tám",
            shipping_city: "TP. Hồ Chí Minh",
            shipping_district: "Quận Tân Bình",
            shipping_ward: "Phường 4",
            sub_total: 850000,
            shipping_fee: 20000,
            discount_amount: 0,
            grand_total: 870000,
            payment_method: "COD",
            payment_status: "failed",
            status: "cancelled",
            notes_from_customer: "Giao gấp.",
            created_at: "2023-10-24T18:45:00Z",
             items: [
                { name: "Bàn phím cơ Keychron K2", quantity: 1, price: 850000 }
            ]
        }
    ];

    // --- UTILITY FUNCTIONS ---
    const formatCurrency = (amount) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    
    const formatDate = (dateString) => {
        const date = new Date(dateString);
        return date.toLocaleDateString('vi-VN', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    };

    const statusMap = {
        pending_confirmation: { text: "Chờ xác nhận", class: "status-pending_confirmation" },
        processing: { text: "Đang xử lý", class: "status-processing" },
        shipped: { text: "Đã giao hàng", class: "status-shipped" },
        delivered: { text: "Giao thành công", class: "status-delivered" },
        cancelled: { text: "Đã hủy", class: "status-cancelled" }
    };

     const paymentStatusMap = {
        pending: { text: "Chờ thanh toán", class: "payment-pending" },
        paid: { text: "Đã thanh toán", class: "payment-paid" },
        failed: { text: "Thất bại", class: "payment-failed" }
    };

    // --- RENDER FUNCTIONS ---
    function renderOrderRow(order) {
        const orderStatus = statusMap[order.status] || { text: 'N/A', class: '' };
        const paymentStatus = paymentStatusMap[order.payment_status] || { text: 'N/A', class: '' };
        
        return `
            <tr class="bg-white border-b hover:bg-gray-50">
                <td class="p-6 font-bold text-indigo-600">${order.order_code}</td>
                <td class="p-6">
                    <div class="font-semibold">${order.customer_name}</div>
                    <div class="text-gray-500">${order.customer_email}</div>
                </td>
                <td class="p-6 font-semibold">${formatCurrency(order.grand_total)}</td>
                <td class="p-6"><span class="status-badge ${orderStatus.class}">${orderStatus.text}</span></td>
                <td class="p-6"><span class="status-badge ${paymentStatus.class}">${paymentStatus.text}</span></td>
                <td class="p-6">${formatDate(order.created_at)}</td>
                <td class="p-6 text-center">
                    <button onclick='viewOrder(${JSON.stringify(order)})' class="text-indigo-600 hover:text-indigo-900 font-medium text-lg" title="Xem chi tiết">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="text-green-600 hover:text-green-900 font-medium text-lg ml-4" title="Cập nhật trạng thái">
                         <i class="fas fa-edit"></i>
                    </button>
                    <button class="text-red-600 hover:text-red-900 font-medium text-lg ml-4" title="Hủy đơn hàng">
                         <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }

    const tbody = document.getElementById('orders-tbody');
    function renderTable(orders) {
        if (orders.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center p-12 text-gray-500">Không tìm thấy đơn hàng nào.</td></tr>`;
            return;
        }
        tbody.innerHTML = orders.map(renderOrderRow).join('');
    }

    // --- MODAL LOGIC ---
    const modal = document.getElementById('order-detail-modal');

    function viewOrder(order) {
        document.getElementById('modal-order-code').textContent = order.order_code;
        document.getElementById('modal-customer-name').textContent = order.customer_name;
        document.getElementById('modal-customer-email').textContent = order.customer_email;
        document.getElementById('modal-customer-phone').textContent = order.customer_phone;
        
        document.getElementById('modal-shipping-address').innerHTML = `
            ${order.shipping_address_line1}<br>
            ${order.shipping_ward}, ${order.shipping_district},<br>
            ${order.shipping_city}
        `;

        document.getElementById('modal-customer-notes').textContent = order.notes_from_customer || "Không có ghi chú.";

        document.getElementById('modal-order-date').textContent = formatDate(order.created_at);
        
        const orderStatus = statusMap[order.status];
        const modalOrderStatusEl = document.getElementById('modal-order-status');
        modalOrderStatusEl.textContent = orderStatus.text;
        modalOrderStatusEl.className = `status-badge ${orderStatus.class}`;

        const paymentStatus = paymentStatusMap[order.payment_status];
        const modalPaymentStatusEl = document.getElementById('modal-payment-status');
        modalPaymentStatusEl.textContent = paymentStatus.text;
        modalPaymentStatusEl.className = `status-badge ${paymentStatus.class}`;

        document.getElementById('modal-payment-method').textContent = order.payment_method;

        // Render items
        const itemsTbody = document.getElementById('modal-order-items');
        itemsTbody.innerHTML = order.items.map(item => `
            <tr class="border-b last:border-none">
                <td class="p-3 font-medium">${item.name}</td>
                <td class="p-3 text-center">${item.quantity}</td>
                <td class="p-3 text-right">${formatCurrency(item.price)}</td>
                <td class="p-3 text-right font-semibold">${formatCurrency(item.price * item.quantity)}</td>
            </tr>
        `).join('');

        // Render totals
        document.getElementById('modal-sub-total').textContent = formatCurrency(order.sub_total);
        document.getElementById('modal-shipping-fee').textContent = formatCurrency(order.shipping_fee);
        document.getElementById('modal-discount').textContent = `- ${formatCurrency(order.discount_amount)}`;
        document.getElementById('modal-grand-total').textContent = formatCurrency(order.grand_total);
        
        modal.classList.add('is-open');
        modal.querySelector('div').classList.remove('scale-95');
    }

    function closeModal() {
        modal.classList.remove('is-open');
        modal.querySelector('div').classList.add('scale-95');
    }
    
    // Close modal on escape key press
    window.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
            closeModal();
        }
    });

    // --- FILTERING LOGIC ---
    const searchInput = document.getElementById('search');
    const orderStatusFilter = document.getElementById('order-status');
    const paymentStatusFilter = document.getElementById('payment-status');
    const dateFilter = document.getElementById('date-range');
    
    function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase();
        const orderStatus = orderStatusFilter.value;
        const paymentStatus = paymentStatusFilter.value;
        const selectedDate = dateFilter.value;

        let filteredOrders = mockOrders.filter(order => {
            const matchesSearch = searchTerm === '' ||
                order.order_code.toLowerCase().includes(searchTerm) ||
                order.customer_name.toLowerCase().includes(searchTerm) ||
                order.customer_email.toLowerCase().includes(searchTerm) ||
                order.customer_phone.includes(searchTerm);
            
            const matchesOrderStatus = orderStatus === '' || order.status === orderStatus;
            const matchesPaymentStatus = paymentStatus === '' || order.payment_status === paymentStatus;

            const matchesDate = selectedDate === '' || formatDate(order.created_at) === formatDate(selectedDate);

            return matchesSearch && matchesOrderStatus && matchesPaymentStatus && matchesDate;
        });

        renderTable(filteredOrders);
    }
    
    document.getElementById('apply-filters').addEventListener('click', applyFilters);
    document.getElementById('clear-filters').addEventListener('click', () => {
        searchInput.value = '';
        orderStatusFilter.value = '';
        paymentStatusFilter.value = '';
        dateFilter.value = '';
        renderTable(mockOrders);
    });


    // --- INITIAL RENDER ---
    document.addEventListener('DOMContentLoaded', () => {
        renderTable(mockOrders);
    });

    </script>
</body>
</html>
