<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Quản Lý Nhân Viên Đóng Gói</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple transition for view switching */
        .view {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .view.active {
            display: block;
            opacity: 1;
        }
        /* Remove default arrow from select */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        }
        .schedule-grid {
            grid-template-columns: 150px repeat(7, minmax(0, 1fr));
        }
    </style>
</head>
<body class="bg-gray-100 p-6">

    <!-- Main Content -->
    <main class="w-full">

        <!-- Warehouse List View -->
        <div id="stores-view" class="view active">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Quản Lý Nhân Viên Đóng Gói</h1>

            <!-- Combined Filter and Table Block -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <!-- Filter Bar -->
                <div class="p-4 border-b border-gray-200 flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center gap-4 flex-wrap">
                        <select id="province-filter" class="w-full sm:w-56 py-2 px-3 border border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <!-- Options rendered by JS -->
                        </select>
                        <div class="relative flex-grow">
                            <input id="store-search-input" type="text" placeholder="Tìm theo tên kho..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg w-full sm:w-64 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                            </span>
                        </div>
                    </div>
                     <div class="flex items-center gap-3">
                         <button id="view-trash-btn" class="flex items-center gap-2 bg-white text-gray-700 border border-gray-300 font-semibold px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                             <span>Thùng rác</span>
                         </button>
                         <button id="add-staff-btn-global" class="flex items-center gap-2 bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors w-full sm:w-auto">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                             Thêm Nhân Viên
                         </button>
                     </div>
                </div>
                <!-- Warehouse Table -->
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">Tên Kho</th>
                                <th scope="col" class="px-6 py-3">Tỉnh/Thành Phố</th>
                                <th scope="col" class="px-6 py-3">Nhân Viên</th>
                                <th scope="col" class="px-6 py-3 text-center">Hành Động</th>
                            </tr>
                        </thead>
                        <tbody id="store-table-body">
                            <!-- Warehouse data will be inserted here by JS -->
                        </tbody>
                    </table>
                     <div id="no-stores-found" class="text-center py-16 text-gray-500 hidden">
                         <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12V8a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v4"/><path d="M2 20v-4a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2Z"/><path d="M12 14v-2"/><path d="M20 14h.01"/><path d="M4 14h.01"/></svg>
                         <h3 class="mt-2 text-sm font-medium text-gray-900">Không tìm thấy kho</h3>
                         <p class="mt-1 text-sm text-gray-500">Vui lòng thay đổi bộ lọc.</p>
                     </div>
                </div>
            </div>
        </div>

        <!-- Employee List View -->
        <div id="employees-view" class="view">
            <div class="flex items-center justify-between flex-wrap gap-4 mb-6">
                 <div class="flex items-center gap-4">
                     <button id="back-to-stores-btn" class="p-2 rounded-md hover:bg-gray-200">
                         <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-700" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                     </button>
                     <div>
                         <h1 id="employee-view-title" class="text-3xl font-bold text-gray-800"></h1>
                         <p id="employee-view-subtitle" class="text-gray-500"></p>
                     </div>
                 </div>
                 <div class="flex items-center gap-3">
                     <button id="go-to-schedule-view-btn" class="flex items-center gap-2 bg-teal-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-teal-700 transition-colors">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                         Quản Lý Lịch Làm Việc
                     </button>
                     <button id="add-staff-btn-in-view" class="flex items-center gap-2 bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                         Thêm Nhân Viên
                     </button>
                 </div>
            </div>
            
            <!-- Combined Employee Filter and Table -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <!-- Employee Filter Bar -->
                <div class="p-4 border-b border-gray-200">
                    <div class="relative">
                        <input id="employee-search-input" type="text" placeholder="Tìm theo tên, email, sđt..." class="pl-10 pr-4 py-2 border rounded-lg w-full sm:w-72 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        </span>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 w-16 text-center">STT</th>
                                <th scope="col" class="px-6 py-3">Họ và Tên</th>
                                <th scope="col" class="px-6 py-3">Email</th>
                                <th scope="col" class="px-6 py-3">Số Điện Thoại</th>
                                <th scope="col" class="px-6 py-3">Chức Vụ</th>
                                <th scope="col" class="px-6 py-3 text-center">Hành Động</th>
                            </tr>
                        </thead>
                        <tbody id="staff-table-body"></tbody>
                    </table>
                    <div id="no-staff-found" class="text-center py-16 text-gray-500 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><path d="M20 8v6"></path><path d="M23 11h-6"></path></svg>
                        <h3 id="no-staff-found-title" class="mt-2 text-sm font-medium text-gray-900">Chưa có nhân viên</h3>
                        <p class="mt-1 text-sm text-gray-500">Hãy thêm nhân viên đầu tiên cho kho này.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Schedule View -->
        <div id="schedule-view" class="view">
             <div class="flex items-center justify-between flex-wrap gap-4 mb-6">
                 <div class="flex items-center gap-4">
                     <button id="back-to-employees-btn" class="p-2 rounded-md hover:bg-gray-200">
                         <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-700" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                     </button>
                     <div>
                         <h1 id="schedule-view-title" class="text-3xl font-bold text-gray-800">Lịch Làm Việc</h1>
                         <p id="schedule-view-subtitle" class="text-gray-500"></p>
                     </div>
                 </div>
                 <div class="flex items-center gap-3">
                     <button id="prev-week-btn" class="p-2 rounded-md hover:bg-gray-200">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                           <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                         </svg>
                     </button>
                     <span id="current-week-display" class="font-semibold text-gray-700"></span>
                      <button id="next-week-btn" class="p-2 rounded-md hover:bg-gray-200">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                             <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                         </svg>
                      </button>
                 </div>
             </div>

            <div class="bg-white rounded-lg shadow-md overflow-x-auto">
                <div id="schedule-grid-container" class="min-w-[1000px]">
                    <!-- Schedule grid will be rendered here by JS -->
                </div>
            </div>
        </div>
    </main>

    <!-- Add/Edit Staff Modal -->
    <div id="add-staff-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center hidden">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-2xl m-4 transform transition-all scale-95 opacity-0" id="modal-content">
            <h2 id="modal-title" class="text-2xl font-bold text-gray-800 mb-6">Thêm Nhân Viên Mới</h2>
            <form id="add-staff-form">
                <input type="hidden" id="editing-staff-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="new-staff-name">Họ và Tên</label>
                        <input id="new-staff-name" type="text" class="w-full px-4 py-2 border rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Nhập họ và tên" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="new-staff-position">Chức Vụ</label>
                        <input id="new-staff-position" type="text" class="w-full px-4 py-2 border rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="VD: Nhân viên đóng gói" required>
                    </div>
                     <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="new-staff-email">Email</label>
                        <input id="new-staff-email" type="email" class="w-full px-4 py-2 border rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="example@email.com" required>
                    </div>
                     <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="new-staff-phone">Số Điện Thoại</label>
                        <input id="new-staff-phone" type="tel" class="w-full px-4 py-2 border rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="09xxxxxxxx" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="modal-province-select">Tỉnh/Thành phố</label>
                        <select id="modal-province-select" class="w-full px-4 py-2 border rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 text-sm font-semibold mb-2" for="modal-store-select">Kho Làm Việc</label>
                        <select id="modal-store-select" class="w-full px-4 py-2 border rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" required disabled>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" id="cancel-modal-btn" class="px-6 py-2 rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300 font-semibold">Hủy</button>
                    <button type="submit" id="modal-submit-btn" class="px-6 py-2 rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 font-semibold">Thêm Mới</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Schedule Shift Modal -->
    <div id="schedule-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center hidden">
        <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-md m-4 transform transition-all scale-95 opacity-0" id="schedule-modal-content">
            <h2 id="schedule-modal-title" class="text-2xl font-bold text-gray-800 mb-6">Sắp xếp ca</h2>
            <form id="schedule-form">
                <input type="hidden" id="scheduling-staff-id">
                <input type="hidden" id="scheduling-date">
                <div class="space-y-6">
                    <div id="schedule-modal-info" class="text-center">
                        <!-- Info rendered by JS -->
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-semibold mb-2">Ca Làm Việc</label>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <input type="radio" id="shift-morning" name="work-shift" value="Ca Sáng" class="hidden peer">
                                <label for="shift-morning" class="w-full text-center block px-4 py-2 rounded-lg border-2 border-gray-300 cursor-pointer peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600">Ca Sáng</label>
                            </div>
                             <div>
                                <input type="radio" id="shift-afternoon" name="work-shift" value="Ca Chiều" class="hidden peer">
                                <label for="shift-afternoon" class="w-full text-center block px-4 py-2 rounded-lg border-2 border-gray-300 cursor-pointer peer-checked:bg-amber-500 peer-checked:text-white peer-checked:border-amber-500">Ca Chiều</label>
                            </div>
                             <div>
                                <input type="radio" id="shift-evening" name="work-shift" value="Ca Tối" class="hidden peer">
                                <label for="shift-evening" class="w-full text-center block px-4 py-2 rounded-lg border-2 border-gray-300 cursor-pointer peer-checked:bg-indigo-600 peer-checked:text-white peer-checked:border-indigo-600">Ca Tối</label>
                            </div>
                             <div>
                                <input type="radio" id="shift-off" name="work-shift" value="Nghỉ" class="hidden peer">
                                <label for="shift-off" class="w-full text-center block px-4 py-2 rounded-lg border-2 border-gray-300 cursor-pointer peer-checked:bg-gray-600 peer-checked:text-white peer-checked:border-gray-600">Nghỉ</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" id="cancel-schedule-modal-btn" class="px-6 py-2 rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300 font-semibold">Hủy</button>
                    <button type="submit" class="px-6 py-2 rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 font-semibold">Lưu Ca</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA ---
            // Simplified locations data: Province -> Array of Warehouses
            const locations = {
                "Hà Nội": ["Kho tổng Long Biên", "Kho tổng Gia Lâm"],
                "TP. Hồ Chí Minh": ["Kho tổng Thủ Đức", "Kho tổng Tân Bình"],
                "Đà Nẵng": ["Kho tổng Liên Chiểu"]
            };
            
            // --- UTILITY FUNCTIONS ---
            const getStartOfWeek = (date = new Date()) => {
                const d = new Date(date);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is sunday
                return new Date(d.setDate(diff));
            };
            
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            // --- INITIAL DATA SETUP ---
            const today = new Date();
            const startOfWeek = getStartOfWeek(today);
            const monday = formatDate(new Date(startOfWeek));
            const tuesday = formatDate(new Date(new Date(startOfWeek).setDate(startOfWeek.getDate() + 1)));
            const wednesday = formatDate(new Date(new Date(startOfWeek).setDate(startOfWeek.getDate() + 2)));
            const thursday = formatDate(new Date(new Date(startOfWeek).setDate(startOfWeek.getDate() + 3)));

            const initialStaffData = [
                { id: 'NV001', name: 'Nguyễn Văn An', email: 'an.nv@example.com', phone: '0912345678', province: 'Hà Nội', store: 'Kho tổng Long Biên', position: 'Nhân viên đóng gói', schedule: [{ date: monday, shift: 'Ca Sáng' }, { date: tuesday, shift: 'Ca Chiều' }] },
                { id: 'NV002', name: 'Trần Thị Bình', email: 'binh.tt@example.com', phone: '0987654321', province: 'TP. Hồ Chí Minh', store: 'Kho tổng Thủ Đức', position: 'Nhân viên đóng gói', schedule: [{ date: monday, shift: 'Ca Chiều' }, { date: wednesday, shift: 'Ca Tối' }] },
                { id: 'NV003', name: 'Lê Văn Cường', email: 'cuong.lv@example.com', phone: '0905123456', province: 'Đà Nẵng', store: 'Kho tổng Liên Chiểu', position: 'Trưởng ca', schedule: [] },
                { id: 'NV004', name: 'Phạm Thị Dung', email: 'dung.pt@example.com', phone: '0934567890', province: 'Hà Nội', store: 'Kho tổng Long Biên', position: 'Nhân viên đóng gói', schedule: [{ date: tuesday, shift: 'Ca Sáng' }, { date: thursday, shift: 'Ca Tối' }] },
                { id: 'NV005', name: 'Hoàng Văn Em', email: 'em.hv@example.com', phone: '0945678901', province: 'TP. Hồ Chí Minh', store: 'Kho tổng Tân Bình', position: 'Quản lý kho', schedule: [] },
                { id: 'NV006', name: 'Vũ Thị Phương', email: 'phuong.vt@example.com', phone: '0967890123', province: 'TP. Hồ Chí Minh', store: 'Kho tổng Thủ Đức', position: 'Nhân viên đóng gói', schedule: [] },
                { id: 'NV007', name: 'Đặng Minh Quang', email: 'quang.dm@example.com', phone: '0978901234', province: 'Hà Nội', store: 'Kho tổng Gia Lâm', position: 'Nhân viên đóng gói', schedule: [{ date: monday, shift: 'Ca Tối' }] },
            ];

            let staffList = [...initialStaffData];
            let appState = {
                currentView: 'stores', // 'stores', 'employees', 'schedule'
                selectedStore: null, // Now represents a warehouse
                filter: { province: 'Tất cả', search: '' },
                employeeSearch: '',
                currentWeekStartDate: null
            };
            
            // --- DOM ELEMENTS ---
            const views = document.querySelectorAll('.view');
            const provinceFilterEl = document.getElementById('province-filter');
            const storeSearchInputEl = document.getElementById('store-search-input');
            const employeeSearchInputEl = document.getElementById('employee-search-input');
            const storeTableBodyEl = document.getElementById('store-table-body');
            const staffTableBodyEl = document.getElementById('staff-table-body');
            const noStoresEl = document.getElementById('no-stores-found');
            const noStaffEl = document.getElementById('no-staff-found');
            
            // Navigation Buttons
            const backToStoresBtn = document.getElementById('back-to-stores-btn');
            const goToScheduleViewBtn = document.getElementById('go-to-schedule-view-btn');
            const backToEmployeesBtn = document.getElementById('back-to-employees-btn');

            // Modal: Add Staff
            const addStaffModalEl = document.getElementById('add-staff-modal');
            const addStaffBtnGlobal = document.getElementById('add-staff-btn-global');
            const addStaffBtnInView = document.getElementById('add-staff-btn-in-view');
            const cancelModalBtn = document.getElementById('cancel-modal-btn');
            const addStaffForm = document.getElementById('add-staff-form');
            const modalProvinceSelect = document.getElementById('modal-province-select');
            const modalStoreSelect = document.getElementById('modal-store-select');
            
            // Modal: Schedule Shift
            const scheduleModalEl = document.getElementById('schedule-modal');
            const cancelScheduleModalBtn = document.getElementById('cancel-schedule-modal-btn');
            const scheduleForm = document.getElementById('schedule-form');

            // Schedule View Elements
            const scheduleGridContainerEl = document.getElementById('schedule-grid-container');
            const prevWeekBtn = document.getElementById('prev-week-btn');
            const nextWeekBtn = document.getElementById('next-week-btn');
            const currentWeekDisplayEl = document.getElementById('current-week-display');

            // --- RENDER & VIEW MANAGEMENT ---
            const switchView = (viewId) => {
                appState.currentView = viewId;
                views.forEach(view => {
                    view.classList.toggle('active', view.id === `${viewId}-view`);
                });
                // Trigger render for the new view
                switch(viewId) {
                    case 'stores': renderStoreList(); break;
                    case 'employees': renderEmployeeList(); break;
                    case 'schedule': renderScheduleView(); break;
                }
            };
            
            const renderStoreList = () => {
                const stores = [];
                Object.keys(locations).forEach(province => {
                    locations[province].forEach(store => {
                        stores.push({ name: store, province });
                    });
                });

                const filteredStores = stores.filter(store => {
                    const provinceMatch = appState.filter.province === 'Tất cả' || store.province === appState.filter.province;
                    const searchMatch = store.name.toLowerCase().includes(appState.filter.search.toLowerCase());
                    return provinceMatch && searchMatch;
                });

                noStoresEl.classList.toggle('hidden', filteredStores.length > 0);
                storeTableBodyEl.innerHTML = filteredStores.map(store => {
                    const employeeCount = staffList.filter(s => s.store === store.name).length;
                    return `
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="px-6 py-4 font-medium text-gray-900"><a href="#" class="view-employees-btn hover:text-indigo-700" data-store-name="${store.name}" data-province-name="${store.province}">${store.name}</a></td>
                            <td class="px-6 py-4">${store.province}</td>
                            <td class="px-6 py-4">${employeeCount}</td>
                            <td class="px-6 py-4 text-center">
                                <div class="flex justify-center items-center gap-2">
                                    <a href="#" class="view-employees-btn bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition-colors" title="Xem chi tiết" data-store-name="${store.name}" data-province-name="${store.province}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                    </a>
                                </div>
                            </td>
                        </tr>`;
                }).join('');
            };
            
            const renderEmployeeList = () => {
                document.getElementById('employee-view-title').innerText = `Nhân viên tại: ${appState.selectedStore.name}`;
                document.getElementById('employee-view-subtitle').innerText = `${appState.selectedStore.province}`;

                let employeesOfStore = staffList.filter(staff => staff.store === appState.selectedStore.name);
                
                if (appState.employeeSearch) {
                    const searchTerm = appState.employeeSearch.toLowerCase();
                    employeesOfStore = employeesOfStore.filter(staff => staff.name.toLowerCase().includes(searchTerm) || staff.email.toLowerCase().includes(searchTerm) || staff.phone.includes(searchTerm));
                }
                
                noStaffEl.classList.toggle('hidden', employeesOfStore.length > 0);
                document.getElementById('no-staff-found-title').innerText = (appState.employeeSearch && employeesOfStore.length === 0) ? 'Không tìm thấy nhân viên' : 'Chưa có nhân viên';

                staffTableBodyEl.innerHTML = employeesOfStore.map((staff, index) => `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-6 py-4 font-medium text-gray-900 text-center">${index + 1}</td>
                        <td class="px-6 py-4 font-medium text-gray-900">${staff.name}</td>
                        <td class="px-6 py-4">${staff.email}</td>
                        <td class="px-6 py-4">${staff.phone}</td>
                        <td class="px-6 py-4">${staff.position}</td>
                        <td class="px-6 py-4 text-center">
                            <div class="flex justify-center items-center gap-2">
                                <button class="edit-btn bg-gray-200 text-gray-800 p-2 rounded-lg hover:bg-gray-300 transition-colors" title="Chỉnh sửa" data-id="${staff.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                                </button>
                                <button class="delete-btn bg-red-600 text-white p-2 rounded-lg hover:bg-red-700 transition-colors" title="Xóa" data-id="${staff.id}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                </button>
                            </div>
                        </td>
                    </tr>`).join('');
            };

            const renderScheduleView = () => {
                document.getElementById('schedule-view-subtitle').innerText = appState.selectedStore.name;
                const startDate = appState.currentWeekStartDate;
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                currentWeekDisplayEl.innerText = `${startDate.toLocaleDateString('vi-VN')} - ${endDate.toLocaleDateString('vi-VN')}`;

                const weekDates = [];
                for(let i=0; i<7; i++) {
                    const date = new Date(startDate);
                    date.setDate(startDate.getDate() + i);
                    weekDates.push(date);
                }

                const employeesOfStore = staffList.filter(staff => staff.store === appState.selectedStore.name);
                
                const dayHeaders = ['Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7', 'Chủ Nhật'];
                let gridHTML = `<div class="grid schedule-grid text-sm">`;
                // Header Row
                gridHTML += `<div class="font-semibold p-2 border-b border-r bg-gray-50 text-gray-600">Nhân viên</div>`;
                weekDates.forEach((date, index) => {
                    gridHTML += `<div class="font-semibold p-2 border-b text-center bg-gray-50 text-gray-600">
                        <div>${dayHeaders[index]}</div>
                        <div class="text-xs font-normal">${date.getDate()}/${date.getMonth()+1}</div>
                    </div>`;
                });

                // Employee Rows
                employeesOfStore.forEach(staff => {
                    gridHTML += `<div class="font-semibold p-3 border-b border-r text-gray-800 bg-gray-50 flex items-center">${staff.name}</div>`;
                    weekDates.forEach(date => {
                        const dateString = formatDate(date);
                        const shift = staff.schedule.find(s => s.date === dateString);
                        let shiftTag = '';
                        if(shift) {
                            const shiftColors = {
                                "Ca Sáng": "bg-blue-100 text-blue-800",
                                "Ca Chiều": "bg-amber-100 text-amber-800",
                                "Ca Tối": "bg-indigo-100 text-indigo-800",
                            };
                            shiftTag = `<div class="font-semibold rounded-md p-2 text-xs ${shiftColors[shift.shift] || ''}">${shift.shift}</div>`;
                        }
                        gridHTML += `<div class="schedule-cell border-b p-2 cursor-pointer hover:bg-indigo-50 min-h-[60px]" data-staff-id="${staff.id}" data-date="${dateString}">${shiftTag}</div>`;
                    });
                });
                
                gridHTML += `</div>`;
                scheduleGridContainerEl.innerHTML = gridHTML;
                 if (employeesOfStore.length === 0) {
                     scheduleGridContainerEl.innerHTML = `<div class="p-8 text-center text-gray-500">Kho này chưa có nhân viên nào.</div>`;
                 }
            };
            
            // --- MODAL & FORM FUNCTIONS ---
            const openAddStaffModal = (staffToEdit = null) => {
                addStaffForm.reset();
                const isEditing = !!staffToEdit;
                document.getElementById('modal-title').innerText = isEditing ? 'Chỉnh Sửa Nhân Viên' : 'Thêm Nhân Viên Mới';
                document.getElementById('modal-submit-btn').innerText = isEditing ? 'Lưu Thay Đổi' : 'Thêm Mới';
                document.getElementById('editing-staff-id').value = isEditing ? staffToEdit.id : '';
                
                if (isEditing) {
                    document.getElementById('new-staff-name').value = staffToEdit.name;
                    document.getElementById('new-staff-position').value = staffToEdit.position;
                    document.getElementById('new-staff-email').value = staffToEdit.email;
                    document.getElementById('new-staff-phone').value = staffToEdit.phone;
                    populateModalProvinces(staffToEdit.province);
                    populateModalStores(staffToEdit.province, staffToEdit.store);
                } else {
                    if (appState.currentView === 'employees') {
                        const { province, name } = appState.selectedStore;
                        populateModalProvinces(province);
                        populateModalStores(province, name);
                    } else { 
                        populateModalProvinces(); 
                        populateModalStores(null); 
                    }
                }

                addStaffModalEl.classList.remove('hidden');
                setTimeout(() => addStaffModalEl.querySelector('#modal-content').classList.remove('scale-95', 'opacity-0'), 10);
            };

            const closeAddStaffModal = () => {
                addStaffModalEl.querySelector('#modal-content').classList.add('scale-95', 'opacity-0');
                setTimeout(() => addStaffModalEl.classList.add('hidden'), 200);
            };
            
            const openScheduleModal = (staffId, dateString) => {
                scheduleForm.reset();
                const staff = staffList.find(s => s.id === staffId);
                if (!staff) return;
                
                document.getElementById('scheduling-staff-id').value = staffId;
                document.getElementById('scheduling-date').value = dateString;
                
                const dateObj = new Date(dateString);
                // Adjust for timezone offset to prevent date from changing
                const adjustedDate = new Date(dateObj.getTime() + dateObj.getTimezoneOffset() * 60000);

                document.getElementById('schedule-modal-info').innerHTML = `<p class="font-semibold text-gray-800">${staff.name}</p><p class="text-sm text-gray-500">${adjustedDate.toLocaleDateString('vi-VN')}</p>`;

                const existingShift = staff.schedule.find(s => s.date === dateString);
                if (existingShift) {
                    const radio = document.querySelector(`input[name="work-shift"][value="${existingShift.shift}"]`);
                    if (radio) radio.checked = true;
                } else {
                    document.getElementById('shift-off').checked = true;
                }
                
                scheduleModalEl.classList.remove('hidden');
                setTimeout(() => scheduleModalEl.querySelector('#schedule-modal-content').classList.remove('scale-95', 'opacity-0'), 10);
            };
            
            const closeScheduleModal = () => {
                scheduleModalEl.querySelector('#schedule-modal-content').classList.add('scale-95', 'opacity-0');
                setTimeout(() => scheduleModalEl.classList.add('hidden'), 200);
            };
            
            const populateModalProvinces = (selected = null) => {
                 modalProvinceSelect.innerHTML = `<option value="">-- Chọn tỉnh/thành --</option>` + Object.keys(locations).map(p => `<option value="${p}" ${p === selected ? 'selected' : ''}>${p}</option>`).join('');
            };
            
            const populateModalStores = (province, selected = null) => {
                if (!province || !locations[province]) {
                    modalStoreSelect.innerHTML = '<option value="">-- Chọn kho --</option>';
                    modalStoreSelect.disabled = true;
                } else {
                    modalStoreSelect.innerHTML = '<option value="">-- Chọn kho --</option>' + locations[province].map(s => `<option value="${s}" ${s === selected ? 'selected' : ''}>${s}</option>`).join('');
                    modalStoreSelect.disabled = false;
                }
            };
            
             // --- FILTER POPULATION ---
            const renderProvinceFilter = () => {
                provinceFilterEl.innerHTML = `<option value="Tất cả">Tất cả Tỉnh/Thành</option>` + Object.keys(locations).map(p => `<option value="${p}">${p}</option>`).join('');
            };
            
            // --- EVENT HANDLERS ---
            provinceFilterEl.addEventListener('change', (e) => {
                appState.filter.province = e.target.value;
                renderStoreList();
            });
            storeSearchInputEl.addEventListener('input', (e) => { appState.filter.search = e.target.value; renderStoreList(); });
            employeeSearchInputEl.addEventListener('input', (e) => { appState.employeeSearch = e.target.value; renderEmployeeList(); });

            document.body.addEventListener('click', (e) => {
                 const viewEmployeesBtn = e.target.closest('.view-employees-btn');
                 if (viewEmployeesBtn) {
                     e.preventDefault();
                     appState.selectedStore = {
                         name: viewEmployeesBtn.dataset.storeName,
                         province: viewEmployeesBtn.dataset.provinceName,
                     };
                     switchView('employees');
                 }
            });

            backToStoresBtn.addEventListener('click', () => switchView('stores'));
            backToEmployeesBtn.addEventListener('click', () => switchView('employees'));
            goToScheduleViewBtn.addEventListener('click', () => switchView('schedule'));
            
            staffTableBodyEl.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-btn');
                if (editBtn) openAddStaffModal(staffList.find(s => s.id === editBtn.dataset.id));
                
                const deleteBtn = e.target.closest('.delete-btn');
                if (deleteBtn) {
                    // Replace window.confirm with a custom modal in a real app
                    if(confirm(`Bạn có chắc muốn xóa nhân viên này?`)) {
                        staffList = staffList.filter(staff => staff.id !== deleteBtn.dataset.id);
                        renderEmployeeList();
                    }
                }
            });

            addStaffForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = document.getElementById('editing-staff-id').value;
                const staffData = {
                    name: document.getElementById('new-staff-name').value,
                    position: document.getElementById('new-staff-position').value,
                    email: document.getElementById('new-staff-email').value,
                    phone: document.getElementById('new-staff-phone').value,
                    province: document.getElementById('modal-province-select').value,
                    store: document.getElementById('modal-store-select').value,
                };
                if (id) {
                    staffList = staffList.map(s => s.id === id ? { ...s, ...staffData } : s)
                } else {
                    staffList.unshift({ id: `NV${String(Date.now()).slice(-4)}`, schedule:[], ...staffData });
                }
                renderEmployeeList();
                closeAddStaffModal();
            });

            scheduleGridContainerEl.addEventListener('click', (e) => {
                const cell = e.target.closest('.schedule-cell');
                if (cell) {
                    openScheduleModal(cell.dataset.staffId, cell.dataset.date);
                }
            });

            scheduleForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const staffId = document.getElementById('scheduling-staff-id').value;
                const date = document.getElementById('scheduling-date').value;
                const shift = document.querySelector('input[name="work-shift"]:checked').value;
                const staff = staffList.find(s => s.id === staffId);
                
                if (staff) {
                    // Remove existing schedule for that date
                    staff.schedule = staff.schedule.filter(s => s.date !== date);
                    // Add new one if it's not 'Off'
                    if(shift !== 'Nghỉ') {
                        staff.schedule.push({ date, shift });
                    }
                }
                renderScheduleView();
                closeScheduleModal();
            });

            prevWeekBtn.addEventListener('click', () => {
                appState.currentWeekStartDate.setDate(appState.currentWeekStartDate.getDate() - 7);
                renderScheduleView();
            });
            nextWeekBtn.addEventListener('click', () => {
                appState.currentWeekStartDate.setDate(appState.currentWeekStartDate.getDate() + 7);
                renderScheduleView();
            });

            [addStaffBtnGlobal, addStaffBtnInView].forEach(btn => btn.addEventListener('click', () => openAddStaffModal()));
            cancelModalBtn.addEventListener('click', closeAddStaffModal);
            addStaffModalEl.addEventListener('click', (e) => e.target === addStaffModalEl && closeAddStaffModal());
            cancelScheduleModalBtn.addEventListener('click', closeScheduleModal);
            scheduleModalEl.addEventListener('click', (e) => e.target === scheduleModalEl && closeScheduleModal());

            modalProvinceSelect.addEventListener('change', (e) => {
                populateModalStores(e.target.value);
            });

            // --- INITIALIZATION ---
            appState.currentWeekStartDate = getStartOfWeek();
            renderProvinceFilter();
            switchView('stores');
        });
    </script>
</body>
</html>
