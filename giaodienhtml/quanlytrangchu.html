<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Trang chủ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #f8f9fa;
        }
        .draggable-item {
            cursor: grab;
            transition: background-color 0.2s ease;
        }
        .draggable-item:hover {
            background-color: #f9fafb;
        }
        .dragging {
            opacity: 0.5;
            background-color: #eef2ff;
            border: 1px dashed #6366f1;
        }
        /* Toggle Switch CSS */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4f46e5;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4f46e5;
        }
        /* Modal Styles */
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .modal-content {
             transform: scale(0.95);
             transition: transform 0.3s ease;
        }
        .modal:not(.hidden) .modal-content {
            transform: scale(1);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-screen-2xl mx-auto">
        <header class="mb-8 flex justify-between items-center">
            <div>
                 <h1 class="text-3xl font-bold text-gray-800">Quản lý Trang chủ</h1>
                 <p class="text-gray-500 mt-1">Sắp xếp và quản lý các thành phần hiển thị trên trang chủ.</p>
            </div>
            <button class="px-5 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold flex items-center space-x-2">
                <i class="fas fa-save"></i>
                <span>Lưu tất cả thay đổi</span>
            </button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left Column -->
            <div class="space-y-8">
                <!-- Banner Section -->
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Sắp xếp Banner Slider</h2>
                    <p class="text-sm text-gray-500 mb-4">Kéo thả để thay đổi thứ tự hiển thị của banner trên trang chủ.</p>
                    <ul id="banner-list" class="space-y-3">
                        <!-- Banner items injected by JS -->
                    </ul>
                </div>
                
                <!-- Category Section -->
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Quản lý Danh mục Trang chủ</h2>
                    <div>
                        <p class="text-sm text-gray-500 mb-2">Chọn các danh mục bạn muốn hiển thị trên trang chủ.</p>
                        <div id="category-selection-list" class="space-y-2 max-h-48 overflow-y-auto border p-3 rounded-lg">
                            <!-- Checkboxes will be injected here -->
                        </div>
                    </div>
                    <div id="category-sorting-section" class="mt-6 hidden">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Sắp xếp thứ tự</h3>
                        <p class="text-sm text-gray-500 mb-4">Kéo thả để thay đổi thứ tự các danh mục đã chọn.</p>
                        <ul id="category-list" class="space-y-3">
                            <!-- Draggable category items injected by JS -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="space-y-8">
                <!-- Featured Product Blocks Section -->
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">Các khối Sản phẩm Nổi bật</h2>
                        <button id="add-new-block-btn" class="text-indigo-600 font-semibold text-sm flex items-center space-x-1"><i class="fas fa-plus-circle"></i><span>Thêm khối mới</span></button>
                    </div>
                    <div id="product-blocks-container" class="space-y-6">
                        <!-- Product blocks will be injected here -->
                    </div>
                </div>

                <!-- Featured Posts Section -->
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-800">Bài viết Nổi bật</h2>
                         <button class="text-indigo-600 font-semibold text-sm flex items-center space-x-1"><i class="fas fa-plus-circle"></i><span>Thêm bài viết</span></button>
                    </div>
                    <ul id="featured-post-list" class="space-y-3">
                        <!-- Featured post items injected by JS -->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add New Block Modal -->
    <div id="add-block-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-md">
            <form id="add-block-form">
                <div class="p-6 border-b">
                    <h2 class="text-xl font-bold text-gray-800">Thêm khối sản phẩm mới</h2>
                </div>
                <div class="p-8">
                    <label for="block-title" class="block text-sm font-medium text-gray-700 mb-1">Tiêu đề khối <span class="text-red-500">*</span></label>
                    <input type="text" id="block-title" required class="w-full py-2 px-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="VD: Hàng mới về">
                </div>
                <div class="p-4 bg-gray-50 border-t flex justify-end space-x-3 rounded-b-2xl">
                    <button type="button" id="cancel-add-block-btn" class="px-5 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold">Hủy</button>
                    <button type="submit" class="px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold">Thêm khối</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- MOCK DATA ---
            let mockData = {
                banners: [
                    { id: 1, title: 'Đại tiệc Sale Hè', image_path: 'https://placehold.co/1200x400/3B82F6/FFFFFF?text=Sale+He+2025' },
                    { id: 4, title: 'Back to School 2025', image_path: 'https://placehold.co/1200x400/EC4899/FFFFFF?text=Back+to+School' },
                    { id: 2, title: 'Laptop Gaming Giảm Sốc', image_path: 'https://placehold.co/1200x400/10B981/FFFFFF?text=Laptop+Gaming' },
                ],
                categories: [
                    { id: 1, name: 'Điện thoại', show_on_homepage: true, order: 1 },
                    { id: 4, name: 'Laptop', show_on_homepage: true, order: 2 },
                    { id: 7, name: 'Phụ kiện', show_on_homepage: true, order: 3 },
                    { id: 8, name: 'Đồng hồ thông minh', show_on_homepage: false, order: 4 },
                    { id: 9, name: 'Hàng gia dụng', show_on_homepage: false, order: 5 },
                ],
                product_blocks: [
                    { 
                        id: 1, 
                        title: 'Xem đã mắt, nghe đã tai', 
                        is_visible: true, 
                        order: 1, 
                        products: [ 
                            { id: 101, name: 'iPhone 15 Pro Max 256GB', image: 'https://placehold.co/40x40/333/fff?text=P' },
                            { id: 204, name: 'Tai nghe SoundMax Pro', image: 'https://placehold.co/60x60/CCCCCC/FFFFFF?text=Tai+Nghe' }
                        ] 
                    },
                    { 
                        id: 2, 
                        title: 'Bán chạy nhất', 
                        is_visible: true, 
                        order: 2, 
                        products: [
                            { id: 203, name: 'Laptop UltraBook Zen 14', image: 'https://placehold.co/60x60/CCCCCC/FFFFFF?text=Laptop' }
                        ]
                    },
                     { 
                        id: 3, 
                        title: 'Đồng hồ mới nhất', 
                        is_visible: false, 
                        order: 3, 
                        products: [] 
                    }
                ],
                featured_posts: [
                    { id: 1, title: '10 Mẹo Tối Ưu Hóa SEO Cho Website' },
                    { id: 2, title: 'Đánh giá chi tiết tai nghe SoundMax Pro' },
                ]
            };

            // --- DOM ELEMENTS ---
            const bannerList = document.getElementById('banner-list');
            const categorySelectionList = document.getElementById('category-selection-list');
            const categorySortingSection = document.getElementById('category-sorting-section');
            const categoryList = document.getElementById('category-list');
            const productBlocksContainer = document.getElementById('product-blocks-container');
            const featuredPostList = document.getElementById('featured-post-list');
            const addBlockModal = document.getElementById('add-block-modal');
            const addBlockForm = document.getElementById('add-block-form');
            const addNewBlockBtn = document.getElementById('add-new-block-btn');
            const cancelAddBlockBtn = document.getElementById('cancel-add-block-btn');

            // --- RENDER FUNCTIONS ---
            const renderBannerList = () => {
                bannerList.innerHTML = mockData.banners.map(banner => `
                    <li data-id="${banner.id}" draggable="true" class="draggable-item flex items-center space-x-4 p-3 border rounded-lg">
                        <i class="fas fa-grip-vertical text-gray-400 cursor-grab"></i>
                        <img src="${banner.image_path}" class="w-24 h-10 object-cover rounded-md bg-gray-200">
                        <span class="font-semibold flex-grow">${banner.title}</span>
                        <button class="text-red-500 hover:text-red-700 text-sm"><i class="fas fa-times-circle"></i></button>
                    </li>
                `).join('');
            };

            const renderCategorySelectionList = () => {
                categorySelectionList.innerHTML = mockData.categories.map(cat => `
                    <label class="flex items-center space-x-3 p-2 rounded-md hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" data-id="${cat.id}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${cat.show_on_homepage ? 'checked' : ''}>
                        <span class="text-gray-700">${cat.name}</span>
                    </label>
                `).join('');
            };

            const renderCategoryList = () => {
                const categoriesToShow = mockData.categories
                    .filter(cat => cat.show_on_homepage)
                    .sort((a, b) => a.order - b.order);

                if (categoriesToShow.length > 0) {
                    categorySortingSection.classList.remove('hidden');
                    categoryList.innerHTML = categoriesToShow.map(cat => `
                         <li data-id="${cat.id}" draggable="true" class="draggable-item flex items-center space-x-4 p-3 border rounded-lg">
                            <i class="fas fa-grip-vertical text-gray-400 cursor-grab"></i>
                            <span class="font-semibold flex-grow">${cat.name}</span>
                        </li>
                    `).join('');
                } else {
                    categorySortingSection.classList.add('hidden');
                    categoryList.innerHTML = '';
                }
            };

            const renderProductBlocks = () => {
                productBlocksContainer.innerHTML = mockData.product_blocks
                    .sort((a,b) => a.order - b.order)
                    .map(block => `
                    <div data-id="${block.id}" draggable="true" class="draggable-item border rounded-xl bg-white">
                        <div class="flex justify-between items-center p-4 border-b">
                             <div class="flex items-center space-x-3">
                                <i class="fas fa-grip-vertical text-gray-400 cursor-grab"></i>
                                <h3 class="font-bold text-gray-800">${block.title}</h3>
                            </div>
                            <div class="flex items-center space-x-4">
                                <!-- Toggle Switch -->
                                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="toggle" id="toggle-${block.id}" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" ${block.is_visible ? 'checked' : ''}/>
                                    <label for="toggle-${block.id}" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                                <button class="text-gray-400 hover:text-red-500"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="p-4">
                            <ul data-block-id="${block.id}" class="product-list space-y-3">
                                ${block.products.map(prod => `
                                    <li data-id="${prod.id}" draggable="true" class="draggable-item flex items-center space-x-4 p-2 border rounded-lg">
                                        <i class="fas fa-grip-vertical text-gray-400 cursor-grab"></i>
                                        <img src="${prod.image}" class="w-10 h-10 object-cover rounded-md bg-gray-200">
                                        <span class="font-semibold flex-grow text-sm">${prod.name}</span>
                                        <button class="text-red-500 hover:text-red-700 text-xs"><i class="fas fa-times-circle"></i></button>
                                    </li>
                                `).join('')}
                                 ${block.products.length === 0 ? `<li class="text-center text-gray-400 text-sm py-4">Chưa có sản phẩm nào.</li>` : ''}
                            </ul>
                            <div class="mt-4 pt-4 border-t">
                                 <button class="text-indigo-600 font-semibold text-sm w-full text-left flex items-center space-x-1"><i class="fas fa-search"></i><span>Tìm & Thêm sản phẩm...</span></button>
                            </div>
                        </div>
                    </div>
                `).join('');

                // Re-attach drag-drop listeners for new product lists
                document.querySelectorAll('.product-list').forEach(list => {
                    const blockId = parseInt(list.dataset.blockId);
                    const block = mockData.product_blocks.find(b => b.id === blockId);
                    if (block) {
                        setupDragAndDrop(list, block.products);
                    }
                });
            };
            
            const renderFeaturedPostList = () => {
                featuredPostList.innerHTML = mockData.featured_posts.map(post => `
                     <li data-id="${post.id}" draggable="true" class="draggable-item flex items-center space-x-4 p-3 border rounded-lg">
                        <i class="fas fa-grip-vertical text-gray-400 cursor-grab"></i>
                        <div class="bg-indigo-100 text-indigo-600 rounded-lg w-12 h-12 flex items-center justify-center flex-shrink-0"><i class="fas fa-file-alt fa-lg"></i></div>
                        <span class="font-semibold flex-grow">${post.title}</span>
                        <button class="text-red-500 hover:text-red-700 text-sm"><i class="fas fa-times-circle"></i></button>
                    </li>
                `).join('');
            };
            
            // --- MODAL LOGIC ---
            const openNewBlockModal = () => {
                addBlockForm.reset();
                addBlockModal.classList.remove('hidden');
            };
            const closeNewBlockModal = () => {
                addBlockModal.classList.add('hidden');
            };
            addNewBlockBtn.addEventListener('click', openNewBlockModal);
            cancelAddBlockBtn.addEventListener('click', closeNewBlockModal);
            addBlockForm.addEventListener('submit', e => {
                e.preventDefault();
                const newTitle = document.getElementById('block-title').value.trim();
                if (!newTitle) return;

                const newBlock = {
                    id: Math.max(0, ...mockData.product_blocks.map(b => b.id)) + 1,
                    title: newTitle,
                    is_visible: true,
                    order: mockData.product_blocks.length + 1,
                    products: []
                };
                mockData.product_blocks.push(newBlock);
                renderProductBlocks();
                closeNewBlockModal();
            });


            // --- EVENT LISTENERS ---
            categorySelectionList.addEventListener('change', e => {
                if (e.target.type === 'checkbox') {
                    const categoryId = parseInt(e.target.dataset.id);
                    const isChecked = e.target.checked;
                    const category = mockData.categories.find(c => c.id === categoryId);
                    if (category) {
                        category.show_on_homepage = isChecked;
                        renderCategoryList();
                    }
                }
            });

            // --- DRAG & DROP LOGIC ---
            function setupDragAndDrop(listElement, dataArray, onDropCallback) {
                let draggedItem = null;

                listElement.addEventListener('dragstart', e => {
                    if (e.target.closest('.draggable-item')) {
                        draggedItem = e.target.closest('.draggable-item');
                        setTimeout(() => draggedItem.classList.add('dragging'), 0);
                    }
                });

                listElement.addEventListener('dragend', e => {
                    if (draggedItem) {
                        draggedItem.classList.remove('dragging');
                        draggedItem = null;
                    }
                });
                
                listElement.addEventListener('dragover', e => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(listElement, e.clientY);
                    const currentDragged = document.querySelector('.dragging');
                    if (currentDragged) {
                        if (afterElement == null) {
                            listElement.appendChild(currentDragged);
                        } else {
                            listElement.insertBefore(currentDragged, afterElement);
                        }
                    }
                });

                listElement.addEventListener('drop', e => {
                    e.preventDefault();
                    if (!draggedItem) return;
                    
                    const newOrderIds = [...listElement.querySelectorAll('.draggable-item')].map(item => parseInt(item.dataset.id));
                    
                    dataArray.sort((a, b) => newOrderIds.indexOf(a.id) - newOrderIds.indexOf(b.id));
                    
                    if (onDropCallback) {
                        onDropCallback(dataArray);
                    }
                });
            }

            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.draggable-item:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }
            
            const updateCategoryOrder = (sortedCategories) => {
                sortedCategories.forEach((cat, index) => {
                    const originalCat = mockData.categories.find(c => c.id === cat.id);
                    if (originalCat) originalCat.order = index + 1;
                });
                console.log('New category order updated in mockData.');
            };

            // --- INITIALIZATION ---
            renderBannerList();
            renderCategorySelectionList();
            renderCategoryList();
            renderProductBlocks();
            renderFeaturedPostList();

            setupDragAndDrop(bannerList, mockData.banners);
            setupDragAndDrop(categoryList, mockData.categories.filter(c => c.show_on_homepage), updateCategoryOrder);
            setupDragAndDrop(productBlocksContainer, mockData.product_blocks, renderProductBlocks);
            setupDragAndDrop(featuredPostList, mockData.featured_posts);
        });
    </script>
</body>
</html>
