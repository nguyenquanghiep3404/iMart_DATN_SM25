<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Giao diện Giao hàng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #f4f7fa;
            color: #1a202c;
        }
        .page-container {
            position: relative;
            height: 100%;
            overflow: hidden;
        }
        .page {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 70px; /* Space for bottom nav */
            display: flex;
            flex-direction: column;
            background-color: #f4f7fa;
            transition: opacity 0.2s ease-in-out;
            opacity: 1;
            visibility: visible;
        }
        .page.hidden {
           opacity: 0;
           visibility: hidden;
           transition: opacity 0.2s ease-in-out, visibility 0s linear 0.2s;
        }
        .page-header {
            flex-shrink: 0;
        }
        .page-content {
            flex-grow: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .page-footer {
            flex-shrink: 0;
        }
        .tab-indicator {
            transition: left 0.3s ease-in-out, width 0.3s ease-in-out;
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .modal-content {
            transition: transform 0.3s ease-out;
        }
        .modal.hidden .modal-content {
             transform: translateY(100%);
        }
        /* Overlay page transition */
        .page-overlay {
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
         .page-overlay:not(.hidden) {
            transform: translateX(0);
        }
    </style>
</head>
<body>

    <div class="page-container w-full max-w-md mx-auto bg-white shadow-lg">
        
        <!-- ===== Dashboard Page ===== -->
        <div id="dashboard-page" class="page">
            <header class="page-header p-5 bg-white flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-500">Xin chào,</p>
                    <h1 id="shipper-name" class="text-xl font-bold text-gray-800"></h1>
                </div>
                <button onclick="showNotificationsPage()" class="notification-btn relative text-gray-500 hover:text-indigo-600 h-10 w-10 flex items-center justify-center">
                    <i class="fas fa-bell fa-lg"></i>
                    <span class="notification-dot absolute top-1 right-1 block h-2.5 w-2.5 rounded-full bg-red-500 border-2 border-white"></span>
                </button>
            </header>

            <!-- Tabs -->
            <nav class="page-header sticky top-0 bg-white z-10">
                <div class="relative flex border-b border-gray-200">
                    <button data-tab="pickup" class="tab-btn flex-1 p-4 text-sm font-semibold text-indigo-600">Cần Lấy</button>
                    <button data-tab="shipping" class="tab-btn flex-1 p-4 text-sm font-semibold text-gray-500">Đang Giao</button>
                    <button data-tab="history" class="tab-btn flex-1 p-4 text-sm font-semibold text-gray-500">Lịch Sử</button>
                    <div id="tab-indicator" class="tab-indicator absolute bottom-0 h-1 bg-indigo-600 rounded-t-full"></div>
                </div>
            </nav>

            <main id="order-list-container" class="page-content p-4 space-y-3 bg-gray-50"></main>
        </div>
        
         <!-- ===== Stats Page ===== -->
        <div id="stats-page" class="page hidden">
             <header class="page-header p-5 bg-white border-b flex justify-between items-center">
                 <h1 class="text-xl font-bold text-gray-800">Thống kê & Thu nhập</h1>
                 <button onclick="showNotificationsPage()" class="notification-btn relative text-gray-500 hover:text-indigo-600 h-10 w-10 flex items-center justify-center">
                    <i class="fas fa-bell fa-lg"></i>
                    <span class="notification-dot absolute top-1 right-1 block h-2.5 w-2.5 rounded-full bg-red-500 border-2 border-white"></span>
                </button>
            </header>
            <main class="page-content p-5 space-y-6">
                <!-- Filter -->
                <div>
                     <label class="text-sm font-semibold text-gray-600">Xem theo</label>
                     <div id="stats-filter-container" class="mt-2 flex border border-gray-200 rounded-lg p-1 bg-gray-100">
                         <button data-range="today" class="stats-filter-btn flex-1 p-2 text-sm rounded-md font-semibold bg-white text-indigo-600 shadow">Hôm nay</button>
                         <button data-range="week" class="stats-filter-btn flex-1 p-2 text-sm rounded-md font-semibold text-gray-500">Tuần này</button>
                         <button data-range="month" class="stats-filter-btn flex-1 p-2 text-sm rounded-md font-semibold text-gray-500">Tháng này</button>
                     </div>
                </div>
                
                <!-- KPI Cards -->
                <div class="grid grid-cols-2 gap-4">
                     <div class="bg-white p-4 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-500">Tổng thu nhập</p>
                        <p id="stat-total-income" class="text-2xl font-bold text-green-600">0đ</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-500">Tỉ lệ thành công</p>
                        <p id="stat-success-rate" class="text-2xl font-bold text-blue-600">0%</p>
                    </div>
                     <div class="bg-white p-4 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-500">Đơn thành công</p>
                        <p id="stat-total-delivered" class="text-2xl font-bold text-gray-800">0</p>
                    </div>
                     <div class="bg-white p-4 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-500">Đơn thất bại</p>
                        <p id="stat-total-failed" class="text-2xl font-bold text-gray-800">0</p>
                    </div>
                </div>

                <!-- Chart -->
                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <h3 class="font-bold mb-4">Hiệu suất giao hàng</h3>
                    <canvas id="performance-chart"></canvas>
                </div>
            </main>
        </div>

        <!-- ===== History Page ===== -->
        <div id="history-page-main" class="page hidden">
             <header class="page-header p-5 bg-white border-b flex justify-between items-center">
                 <h1 class="text-xl font-bold text-gray-800">Lịch sử đơn hàng</h1>
                 <button onclick="showNotificationsPage()" class="notification-btn relative text-gray-500 hover:text-indigo-600 h-10 w-10 flex items-center justify-center">
                    <i class="fas fa-bell fa-lg"></i>
                    <span class="notification-dot absolute top-1 right-1 block h-2.5 w-2.5 rounded-full bg-red-500 border-2 border-white"></span>
                </button>
            </header>
            <main id="history-list-container" class="page-content p-4 space-y-3 bg-gray-50"></main>
        </div>
        
        <!-- ===== Profile Page ===== -->
        <div id="profile-page" class="page hidden">
             <header class="page-header p-5 bg-white border-b flex justify-between items-center">
                 <h1 class="text-xl font-bold text-gray-800">Tài khoản của tôi</h1>
                 <button onclick="showNotificationsPage()" class="notification-btn relative text-gray-500 hover:text-indigo-600 h-10 w-10 flex items-center justify-center">
                    <i class="fas fa-bell fa-lg"></i>
                    <span class="notification-dot absolute top-1 right-1 block h-2.5 w-2.5 rounded-full bg-red-500 border-2 border-white"></span>
                </button>
            </header>
            <main class="page-content p-5 space-y-6">
                <div class="flex flex-col items-center space-y-4">
                    <img id="profile-avatar" src="" alt="Avatar" class="w-24 h-24 rounded-full border-4 border-white shadow-lg">
                    <div class="text-center">
                        <h2 id="profile-name" class="text-2xl font-bold text-gray-800"></h2>
                        <p id="profile-phone" class="text-gray-500"></p>
                    </div>
                </div>
    
                <div class="bg-white p-4 rounded-xl shadow-sm">
                     <a href="#" class="flex justify-between items-center text-gray-700 hover:bg-gray-50 p-3 rounded-lg">
                        <span>Đổi mật khẩu</span>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </a>
                     <a href="#" class="flex justify-between items-center text-gray-700 hover:bg-gray-50 p-3 rounded-lg">
                        <span>Trung tâm trợ giúp</span>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                    </a>
                </div>
    
                <div class="pt-6">
                    <button onclick="logout()" class="w-full bg-red-100 text-red-600 font-bold py-3 rounded-lg flex items-center justify-center space-x-2">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Đăng xuất</span>
                    </button>
                </div>
           </main>
        </div>

        <!-- ===== Detail Page (Overlay) ===== -->
        <div id="detail-page" class="page page-overlay hidden z-20 bg-gray-50">
            <header class="page-header sticky top-0 bg-white shadow-sm z-10 p-4 flex items-center space-x-4">
                <button onclick="hideOverlayPage('detail-page')" class="text-gray-600 h-10 w-10 flex items-center justify-center rounded-full hover:bg-gray-100"><i class="fas fa-arrow-left fa-lg"></i></button>
                <h1 class="text-lg font-bold text-gray-800">Chi tiết đơn hàng</h1>
            </header>
            
            <main id="detail-content" class="page-content p-5 space-y-4"></main>

            <footer id="detail-footer" class="page-footer p-4 bg-white border-t"></footer>
        </div>

         <!-- ===== Notifications Page (Overlay) ===== -->
        <div id="notifications-page" class="page page-overlay hidden z-20 bg-gray-50">
            <header class="page-header sticky top-0 bg-white shadow-sm z-10 p-4 flex items-center space-x-4">
                <button onclick="hideOverlayPage('notifications-page')" class="text-gray-600 h-10 w-10 flex items-center justify-center rounded-full hover:bg-gray-100"><i class="fas fa-arrow-left fa-lg"></i></button>
                <h1 class="text-lg font-bold text-gray-800">Thông báo</h1>
            </header>
            <main id="notifications-list-container" class="page-content"></main>
        </div>

        <!-- ===== Bottom Navigation ===== -->
        <nav class="page-footer fixed bottom-0 left-0 right-0 h-[70px] w-full max-w-md mx-auto bg-white border-t border-gray-200 flex justify-around items-center z-30">
             <button onclick="showPage('dashboard-page', this)" class="nav-link text-center text-indigo-600">
                <i class="fas fa-motorcycle fa-lg"></i>
                <span class="block text-xs font-semibold mt-1">Hôm nay</span>
            </button>
             <button onclick="showPage('stats-page', this)" class="nav-link text-center text-gray-500">
                <i class="fas fa-chart-line fa-lg"></i>
                <span class="block text-xs font-semibold mt-1">Thống kê</span>
            </button>
             <button onclick="showPage('history-page-main', this)" class="nav-link text-center text-gray-500">
                <i class="fas fa-history fa-lg"></i>
                <span class="block text-xs font-semibold mt-1">Lịch sử</span>
            </button>
             <button onclick="showPage('profile-page', this)" class="nav-link text-center text-gray-500">
                <i class="fas fa-user-circle fa-lg"></i>
                <span class="block text-xs font-semibold mt-1">Tài khoản</span>
            </button>
        </nav>

    </div>

    <!-- ===== Failure Report Modal ===== -->
    <div id="failure-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-end justify-center z-50">
        <div class="modal-content bg-white rounded-t-2xl shadow-xl w-full max-w-md p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Lý do giao không thành công</h2>
            <div class="space-y-4">
                <div>
                    <label for="failure-reason" class="block text-sm font-medium text-gray-700 mb-1">Lý do chính</label>
                    <select id="failure-reason" class="w-full py-2 px-3 border border-gray-300 bg-white rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="no_contact">Không liên lạc được khách</option>
                        <option value="rescheduled">Khách hẹn giao lại</option>
                        <option value="wrong_address">Sai địa chỉ</option>
                        <option value="other">Lý do khác</option>
                    </select>
                </div>
                <div>
                    <label for="failure-notes" class="block text-sm font-medium text-gray-700 mb-1">Ghi chú thêm</label>
                    <textarea id="failure-notes" rows="3" class="w-full py-2 px-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="VD: Khách hẹn giao sau 17h"></textarea>
                </div>
            </div>
            <div class="mt-6 grid grid-cols-2 gap-3">
                 <button onclick="closeFailureModal()" class="w-full bg-gray-200 text-gray-700 font-bold py-3 rounded-lg">Hủy</button>
                 <button onclick="confirmFailure()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg">Xác nhận</button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- MOCK DATA ---
            const shipperSample = { "name": "Trần Văn Giao", "phone": "0987-654-321", "avatar": "https://placehold.co/100x100/3B82F6/FFFFFF?text=G" };
            let orders = [
                { id: 1, order_code: "DH-20230001", customer_name: "Nguyễn Văn An", customer_phone: "0987654321", shipping_address_full: "123 Đường Lê Lợi, Phường Bến Nghé, Quận 1, TP. Hồ Chí Minh", shipping_address_short: "Quận 1, TP. HCM", grand_total: 25050000, notes_from_customer: "Giao hàng trong giờ hành chính.", status: "awaiting_shipment", delivery_attempt: null, date: '2025-06-26' },
                { id: 2, order_code: "DH-20230002", customer_name: "Trần Thị Bình", customer_phone: "0912345678", shipping_address_full: "456 Đường Nguyễn Huệ, Quận Hoàn Kiếm, Hà Nội", shipping_address_short: "Quận Hoàn Kiếm, Hà Nội", grand_total: 3430000, notes_from_customer: null, status: "awaiting_shipment", delivery_attempt: null, date: '2025-06-26' },
                { id: 3, order_code: "DH-20230003", customer_name: "Lê Văn Cường", customer_phone: "0905123456", shipping_address_full: "789 Đường 3/2, Quận Hải Châu, Đà Nẵng", shipping_address_short: "Quận Hải Châu, Đà Nẵng", grand_total: 575000, notes_from_customer: "Vui lòng gọi trước khi giao.", status: "shipped", delivery_attempt: { reason: "rescheduled", note: "Khách hẹn giao lại chiều" }, date: '2025-06-26' },
                { id: 4, order_code: "DH-20230004", customer_name: "Phạm Thị Dung", customer_phone: "0934567890", shipping_address_full: "246 Đường Võ Văn Tần, Quận 3, TP. Hồ Chí Minh", shipping_address_short: "Quận 3, TP. HCM", grand_total: 18490000, notes_from_customer: "", status: "delivered", delivery_attempt: null, date: '2025-06-26' },
                { id: 5, order_code: "DH-20230005", customer_name: "Hoàng Văn Em", customer_phone: "0978111222", shipping_address_full: "111 Đường CMT8, Quận Tân Bình, TP. Hồ Chí Minh", shipping_address_short: "Quận Tân Bình, TP. HCM", grand_total: 870000, notes_from_customer: "Giao gấp.", status: "failed_delivery", delivery_attempt: null, date: '2025-06-25' },
                { id: 6, order_code: "DH-20230006", customer_name: "Vũ Thị Lan", customer_phone: "0988777666", shipping_address_full: "55 Nguyễn Đình Chiểu, Quận Hai Bà Trưng, Hà Nội", shipping_address_short: "Quận Hai Bà Trưng, Hà Nội", grand_total: 1250000, notes_from_customer: "Chỉ nhận hàng sau 17h.", status: "shipped", delivery_attempt: null, date: '2025-06-26' },
                { id: 7, order_code: "DH-20230007", customer_name: "Trần Anh Tuấn", customer_phone: "0988111222", shipping_address_full: "100 Phố Huế, Hai Bà Trưng, Hà Nội", shipping_address_short: "Hai Bà Trưng, Hà Nội", grand_total: 350000, notes_from_customer: "", status: "delivered", delivery_attempt: null, date: '2025-06-25' },
                { id: 8, order_code: "DH-20230008", customer_name: "Ngô Bảo Châu", customer_phone: "0988333444", shipping_address_full: "25 Hàng Bài, Hoàn Kiếm, Hà Nội", shipping_address_short: "Hoàn Kiếm, Hà Nội", grand_total: 2100000, notes_from_customer: "", status: "delivered", delivery_attempt: null, date: '2025-06-24' },
                { id: 9, order_code: "DH-20230009", customer_name: "Lê Thị Hồng", customer_phone: "0988555666", shipping_address_full: "300 Bạch Mai, Hai Bà Trưng, Hà Nội", shipping_address_short: "Hai Bà Trưng, Hà Nội", grand_total: 750000, notes_from_customer: "", status: "delivered", delivery_attempt: null, date: '2025-06-20' },
            ];
             const mockNotifications = [
                { type: 'assigned', order_code: 'DH-20230010', time: '5 phút trước' },
                { type: 'success', order_code: 'DH-20230004', time: '1 giờ trước' },
                { type: 'failed', order_code: 'DH-20230005', time: 'Hôm qua' },
                { type: 'system', message: 'Cập nhật hệ thống vào 2h sáng.', time: '2 ngày trước' }
            ];
            
            let activeTab = 'pickup';
            let activeOrder = null;
            let performanceChart = null;

            // --- DOM ELEMENTS ---
            const allPages = document.querySelectorAll('.page');
            const navLinks = document.querySelectorAll('.nav-link');
            const shipperNameEl = document.getElementById('shipper-name');
            const dashboardPage = document.getElementById('dashboard-page');
            const detailPage = document.getElementById('detail-page');
            const notificationsPage = document.getElementById('notifications-page');
            const orderListContainer = document.getElementById('order-list-container');
            const historyListContainer = document.getElementById('history-list-container');
            const notificationsListContainer = document.getElementById('notifications-list-container');
            const detailContent = document.getElementById('detail-content');
            const detailFooter = document.getElementById('detail-footer');
            const tabIndicator = document.getElementById('tab-indicator');
            const tabButtons = document.querySelectorAll('.tab-btn');
            const failureModal = document.getElementById('failure-modal');
            const statsFilterContainer = document.getElementById('stats-filter-container');

            // --- HELPER FUNCTIONS ---
            const formatCurrency = (amount) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);

            // --- PAGE NAVIGATION ---
            window.showPage = (pageId, clickedLink = null) => {
                allPages.forEach(page => {
                    if (!page.classList.contains('page-overlay')) {
                        page.classList.add('hidden');
                    }
                });
                document.getElementById(pageId).classList.remove('hidden');

                if (clickedLink) {
                    navLinks.forEach(link => link.classList.replace('text-indigo-600', 'text-gray-500'));
                    clickedLink.classList.replace('text-gray-500', 'text-indigo-600');
                }
                
                if (pageId === 'stats-page') renderStatsPage('today');
                if (pageId === 'history-page-main') renderHistoryList();
                if (pageId === 'profile-page') renderProfilePage();
            };

            window.showOverlayPage = (pageId) => {
                 document.getElementById(pageId).classList.remove('hidden');
            }
             window.hideOverlayPage = (pageId) => {
                 document.getElementById(pageId).classList.add('hidden');
            }

            // --- RENDER FUNCTIONS ---
            const renderOrderCard = (order) => {
                let attemptNoteHTML = '';
                if (order.status === 'shipped' && order.delivery_attempt) {
                    attemptNoteHTML = `<div class="mt-2 pt-2 border-t border-dashed"><p class="text-xs text-orange-600 font-semibold"><i class="fas fa-clock mr-1"></i> Hẹn giao lại: ${order.delivery_attempt.note}</p></div>`;
                }
                
                let historyStatusHTML = '';
                if (order.status === 'delivered') {
                    historyStatusHTML = `<div class="mt-2 pt-2 border-t border-dashed"><p class="text-sm text-green-600 font-bold flex items-center"><i class="fas fa-check-circle mr-2"></i> Giao thành công</p></div>`;
                } else if (order.status === 'failed_delivery') {
                    historyStatusHTML = `<div class="mt-2 pt-2 border-t border-dashed"><p class="text-sm text-red-600 font-bold flex items-center"><i class="fas fa-times-circle mr-2"></i> Giao thất bại</p></div>`;
                }

                return `<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200" onclick="showDetail(${order.id})"><div class="flex justify-between items-center mb-2"><span class="font-bold text-gray-800">${order.order_code}</span><span class="font-bold text-indigo-600 text-lg">${formatCurrency(order.grand_total)}</span></div><p class="text-sm font-semibold text-gray-700">${order.customer_name}</p><p class="text-sm text-gray-500">${order.shipping_address_short}</p>${attemptNoteHTML}${historyStatusHTML}</div>`;
            }
            
            const renderOrderListForDashboard = (status) => {
                let filteredOrders = [];
                if (status === 'pickup') {
                    filteredOrders = orders.filter(o => o.status === 'awaiting_shipment');
                } else if (status === 'shipping') {
                    filteredOrders = orders.filter(o => o.status === 'shipped');
                } else {
                    filteredOrders = orders.filter(o => o.status === 'delivered' || o.status === 'failed_delivery');
                }

                orderListContainer.innerHTML = filteredOrders.length === 0 ? `<p class="text-center text-gray-500 mt-10">Không có đơn hàng nào.</p>` : filteredOrders.map(renderOrderCard).join('');
            };

            const renderHistoryList = () => {
                 const historyOrders = orders.filter(o => o.status === 'delivered' || o.status === 'failed_delivery').sort((a, b) => new Date(b.date) - new Date(a.date));
                 historyListContainer.innerHTML = historyOrders.length === 0 ? `<p class="text-center text-gray-500 mt-10">Chưa có lịch sử giao hàng.</p>` : historyOrders.map(renderOrderCard).join('');
            }
            
            const renderDetail = (order) => {
                let finalStatusHTML = '';
                if (order.status === 'delivered') {
                    finalStatusHTML = `<div class="bg-green-100 text-green-700 p-4 rounded-xl shadow-sm text-center font-bold flex items-center justify-center space-x-2"><i class="fas fa-check-circle"></i><span>Đã giao hàng thành công</span></div>`;
                } else if (order.status === 'failed_delivery') {
                    finalStatusHTML = `<div class="bg-red-100 text-red-700 p-4 rounded-xl shadow-sm text-center font-bold flex items-center justify-center space-x-2"><i class="fas fa-times-circle"></i><span>Giao hàng thất bại</span></div>`;
                }

                detailContent.innerHTML = `${finalStatusHTML}<div class="bg-white p-4 rounded-xl shadow-sm space-y-3"><h3 class="text-base font-bold text-gray-800">Thông tin người nhận</h3><p class="font-semibold">${order.customer_name}</p><div class="flex items-center justify-between"><p class="text-gray-700">${order.customer_phone}</p><a href="tel:${order.customer_phone}" class="h-10 w-10 flex items-center justify-center bg-blue-100 text-blue-600 rounded-full"><i class="fas fa-phone-alt"></i></a></div><div class="flex items-center justify-between"><p class="text-gray-700">${order.shipping_address_full}</p><a href="https://maps.google.com/?q=${encodeURIComponent(order.shipping_address_full)}" target="_blank" class="h-10 w-10 flex items-center justify-center bg-blue-100 text-blue-600 rounded-full"><i class="fas fa-map-marker-alt"></i></a></div></div><div class="bg-white p-4 rounded-xl shadow-sm space-y-2"><h3 class="text-base font-bold text-gray-800">Thông tin đơn hàng</h3><p class="text-sm text-gray-700">Mã đơn: <span class="font-semibold">${order.order_code}</span></p>${order.notes_from_customer ? `<p class="text-sm text-gray-700">Ghi chú: <span class="font-semibold italic">${order.notes_from_customer}</span></p>` : ''}</div><div class="bg-white p-4 rounded-xl shadow-sm text-center"><p class="text-gray-500">Tổng tiền thu hộ (COD)</p><p class="text-3xl font-bold text-green-600">${formatCurrency(order.grand_total)}</p></div>`;
                
                let footerHTML = '';
                if (order.status === 'awaiting_shipment') {
                    footerHTML = `<button onclick="updateOrderStatus(${order.id}, 'shipped')" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg">ĐÃ LẤY HÀNG</button>`;
                } else if (order.status === 'shipped') {
                    footerHTML = `<div class="grid grid-cols-2 gap-3"><button onclick="openFailureModal(${order.id})" class="w-full bg-orange-500 text-white font-bold py-3 rounded-lg">GIAO THẤT BẠI</button><button onclick="updateOrderStatus(${order.id}, 'delivered')" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg">GIAO THÀNH CÔNG</button></div>`;
                }
                detailFooter.innerHTML = footerHTML;
            };

            const renderProfilePage = () => {
                document.getElementById('profile-name').textContent = shipperSample.name;
                document.getElementById('profile-phone').textContent = shipperSample.phone;
                document.getElementById('profile-avatar').src = shipperSample.avatar;
            }
            
            const renderNotificationsPage = () => {
                 const renderItem = (noti) => {
                    let iconHTML, title, description;
                    switch(noti.type) {
                        case 'assigned':
                            iconHTML = `<div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0"><i class="fas fa-box-check text-blue-500"></i></div>`;
                            title = `Bạn có đơn hàng mới!`;
                            description = `Đơn hàng <strong>${noti.order_code}</strong> đã được gán cho bạn.`;
                            break;
                        case 'success':
                            iconHTML = `<div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center flex-shrink-0"><i class="fas fa-check-circle text-green-500"></i></div>`;
                            title = `Giao hàng thành công`;
                            description = `Bạn đã giao thành công đơn hàng <strong>${noti.order_code}</strong>.`;
                            break;
                        case 'failed':
                            iconHTML = `<div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center flex-shrink-0"><i class="fas fa-exclamation-circle text-red-500"></i></div>`;
                            title = `Giao hàng thất bại`;
                            description = `Đơn hàng <strong>${noti.order_code}</strong> đã được ghi nhận thất bại.`;
                            break;
                        case 'system':
                        default:
                            iconHTML = `<div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center flex-shrink-0"><i class="fas fa-cog text-gray-500"></i></div>`;
                            title = `Thông báo hệ thống`;
                            description = noti.message;
                            break;
                    }
                    return `<div class="flex items-start space-x-4 p-4 border-b bg-white"><div class="flex-1"><p class="font-semibold text-gray-800">${title}</p><p class="text-sm text-gray-600">${description}</p><p class="text-xs text-gray-400 mt-1">${noti.time}</p></div></div>`;
                };
                notificationsListContainer.innerHTML = mockNotifications.map(renderItem).join('');
            }

            // --- EVENT HANDLERS & LOGIC ---
            window.showDetail = (orderId) => {
                const order = orders.find(o => o.id === orderId);
                if (order) {
                    activeOrder = order;
                    renderDetail(order);
                    showOverlayPage('detail-page');
                }
            };
            
            window.showDashboard = () => {
                hideOverlayPage('detail-page');
                activeOrder = null;
                renderOrderListForDashboard(activeTab);
            };
            
            window.showNotificationsPage = () => {
                renderNotificationsPage();
                showOverlayPage('notifications-page');
                document.querySelectorAll('.notification-dot').forEach(dot => dot.classList.add('hidden'));
            };
            
            window.updateOrderStatus = (orderId, newStatus) => {
                const orderIndex = orders.findIndex(o => o.id === orderId);
                if (orderIndex !== -1) {
                    orders[orderIndex].status = newStatus;
                    orders[orderIndex].delivery_attempt = null; 
                }
                showDashboard();
            };
            
            window.openFailureModal = (orderId) => {
                 activeOrder = orders.find(o => o.id === orderId);
                 document.getElementById('failure-notes').value = '';
                 failureModal.classList.remove('hidden');
            };

            window.closeFailureModal = () => failureModal.classList.add('hidden');
            
            window.confirmFailure = () => {
                if (!activeOrder) return;
                const reason = document.getElementById('failure-reason').value;
                const notes = document.getElementById('failure-notes').value;
                const orderIndex = orders.findIndex(o => o.id === activeOrder.id);
                if (orderIndex === -1) return;

                if (reason === 'rescheduled') {
                    orders[orderIndex].delivery_attempt = { reason: 'rescheduled', note: notes || 'Khách hẹn giao lại' };
                } else {
                    orders[orderIndex].status = 'failed_delivery';
                }
                closeFailureModal();
                showDashboard();
            };
            
            window.logout = () => {
                alert('Bạn đã đăng xuất!');
            };

            const updateTabIndicator = (selectedTab) => {
                tabIndicator.style.left = `${selectedTab.offsetLeft}px`;
                tabIndicator.style.width = `${selectedTab.offsetWidth}px`;
            };

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    activeTab = button.dataset.tab;
                    tabButtons.forEach(btn => btn.classList.replace('text-indigo-600', 'text-gray-500'));
                    button.classList.replace('text-gray-500', 'text-indigo-600');
                    updateTabIndicator(button);
                    renderOrderListForDashboard(activeTab);
                });
            });

            // --- STATS PAGE LOGIC ---
            const renderStatsPage = (range) => {
                const now = new Date('2025-06-26T14:52:00+07:00'); 
                let startDate = new Date(now);

                switch(range) {
                    case 'week':
                        startDate.setDate(now.getDate() - now.getDay());
                        break;
                    case 'month':
                        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        break;
                    case 'today':
                    default:
                         startDate.setHours(0, 0, 0, 0);
                        break;
                }
                startDate.setHours(0,0,0,0);

                const filteredOrders = orders.filter(o => {
                    const orderDate = new Date(o.date);
                    return orderDate >= startDate && orderDate <= now;
                });

                const delivered = filteredOrders.filter(o => o.status === 'delivered');
                const failed = filteredOrders.filter(o => o.status === 'failed_delivery');
                const totalIncome = delivered.reduce((sum, o) => sum + o.grand_total, 0);
                const totalFinished = delivered.length + failed.length;
                const successRate = totalFinished > 0 ? Math.round((delivered.length / totalFinished) * 100) : 0;

                document.getElementById('stat-total-income').textContent = formatCurrency(totalIncome);
                document.getElementById('stat-total-delivered').textContent = delivered.length;
                document.getElementById('stat-total-failed').textContent = failed.length;
                document.getElementById('stat-success-rate').textContent = `${successRate}%`;
                
                renderPerformanceChart(filteredOrders, range);
            }
            
            const renderPerformanceChart = (filteredOrders, range) => {
                const ctx = document.getElementById('performance-chart').getContext('2d');
                const dailyData = {};
                
                filteredOrders.forEach(order => {
                    if(order.status === 'delivered') {
                        const dateKey = new Date(order.date).toLocaleDateString('en-CA'); // yyyy-MM-dd
                        dailyData[dateKey] = (dailyData[dateKey] || 0) + 1;
                    }
                });

                const sortedDates = Object.keys(dailyData).sort();
                const labels = sortedDates.map(date => new Date(date).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit'}));
                const data = sortedDates.map(date => dailyData[date]);
                
                if (performanceChart) {
                    performanceChart.destroy();
                }
                performanceChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Số đơn thành công',
                            data: data,
                            backgroundColor: 'rgba(79, 70, 229, 0.8)',
                            borderColor: 'rgba(79, 70, 229, 1)',
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            }

            statsFilterContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    statsFilterContainer.querySelectorAll('button').forEach(btn => {
                        btn.classList.remove('bg-white', 'text-indigo-600', 'shadow');
                        btn.classList.add('text-gray-500');
                    });
                    e.target.classList.add('bg-white', 'text-indigo-600', 'shadow');
                    e.target.classList.remove('text-gray-500');
                    renderStatsPage(e.target.dataset.range);
                }
            });


            // --- INITIALIZATION ---
            shipperNameEl.textContent = shipperSample.name;
            const initialTab = document.querySelector(`.tab-btn[data-tab="${activeTab}"]`);
            updateTabIndicator(initialTab);
            renderOrderListForDashboard(activeTab);
            showPage('dashboard-page', document.querySelector('.nav-link'));
        });
    </script>
</body>
</html>
